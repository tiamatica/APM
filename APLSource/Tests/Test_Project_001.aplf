 R←Test_Project_001(stopFlag batchFlag);⎕TRAP;dir;dist;lines;rc;msg;ns;registry;uri;prj_dir;_;pcfg;gcfg;cfg;refs
⍝ Install packages into a "project" folder
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')
 R←T._Failed

 ns←''
 dir←getTempDir ⍬
 rc registry←APM CreateTestRegistryVersions1 dir
 assert 0=rc

 uri←APM.PathToUri registry
 rc msg gcfg←APM.AddRegistry'test'uri
 →T.GoToTidyUp 0≠rc

 _←3 ⎕MKDIR prj_dir←dir,'/project'
 rc msg pcfg←APM.InitPackage prj_dir
 →T.GoToTidyUp 0≠rc

 rc msg pcfg←prj_dir APM.AddPackage'GroupA-Test1-v0.1.0'
 →T.GoToTidyUp 0≠rc
 rc msg pcfg←prj_dir APM.AddPackage'GroupA-Test2-v2.3.0'
 →T.GoToTidyUp 0≠rc

 rc msg←APM.EstablishDepTree prj_dir
 →T.GoToTidyUp 0≠rc

 rc msg←APM.InstallPackages prj_dir
 →T.GoToTidyUp 0≠rc

 rc msg refs←APM.LoadPackages prj_dir
 →T.GoToTidyUp 0≠rc

 ns←⎕NS''
 ns⍎¨refs

 →T.GoToTidyUp'0.1.0'≢ns.Test1 ⍬
 →T.GoToTidyUp'2.3.0-0.1.1'≢ns.Test2.Version ⍬

 R←T._OK

∆TidyUp:
 :Trap 6 ⋄ ⎕EX⍕ns ⋄ :EndTrap
 ⎕EX'#._apm'
 _←APM.RemoveRegistry'test'
 3 ⎕NDELETE dir
⍝Done
